---
#dofus' binaries are still 32bit only
app-id: com.ankama.Dofus
runtime: org.winepak.Platform/i386/3.0
sdk: org.winepak.Sdk/i386/3.0

tags:
- proprietary

finish-args:
- "--share=ipc"
- "--share=network"
- "--socket=x11"
- "--device=dri"
- "--socket=pulseaudio"
- "--env=PATH=/app/wine/bin:/app/bin:/usr/bin"
- "--env=GTK_PATH=/app/lib/gtk-2.0"
- "--env=G_FILENAME_ENCODING=UTF-8"
- "--device=all"
- "--allow=multiarch"
- "--extra-data=dofus.tar.gz:a57149c0d0ad8c44a3be0d2ada381d8032e923e55d0225243aece626e4d45296:12821292:12821292:http://dl.ak.ankama.com/games/installers/dofus-x86.tar.gz"

command: "start"

build-options:
  cflags: -O2 -pipe -fstack-protector-strong -fno-plt -frecord-gcc-switches -D_FORTIFY_SOURCE=1 -msse -msse2 -msse3 -mssse3 -mfpmath=sse
  cxxflags: -O2 -pipe -fstack-protector-strong -fno-plt -frecord-gcc-switches -D_FORTIFY_SOURCE=1 -msse -msse2 -msse3 -mssse3 -mfpmath=sse
  ldflags: -fstack-protector-strong -Wl,-z,relro,-z,now
  prefix: "/app"
  libdir: "/app/lib"

modules:
- name: wine-win32
  config-opts:
  - --disable-win64
  - --disable-win16
  - --disable-tests
  - --with-x
  - --with-ldap
  - --with-netapi
  - --without-cups
  - --without-curses
  - --without-capi
  - --without-glu
  - --without-gphoto
  - --without-gsm
  - --without-hal
  - --without-opencl
  - --without-pcap
  - --without-udev
  cleanup:
  - /app/wine/app/wine/share/man
  - /app/wine/share/applications
  sources:
  - type: archive
    url: https://dl.winehq.org/wine/source/4.0/wine-4.0.tar.xz
    sha256: 6736cdee95b2b8bb021ec0c19497ed8cad5ae2c8bfdb7ab5dc687ff92a480d4d

- name: libpng12
  sources:
  - type: archive
    url: https://sourceforge.net/projects/libpng/files/libpng12/1.2.59/libpng-1.2.59.tar.xz
    sha256: b4635f15b8adccc8ad0934eea485ef59cc4cae24d0f0300a9a941e51974ffcc7

#(flatpak 1.0.2)per user installation cannot be handled by apply_extra
- name: dofus
  no-autogen: true
  buildsystem: simple
  build-commands:
  - install -d /app/bin
  - install -Dm555 user-install /app/bin
  - install -Dm555 start /app/bin
  sources:
  - type: script
    dest-filename: user-install
    commands:
      - "tar -xf /app/extra/dofus.tar.gz -C /var/data"
      - "chmod 777 /var/data/Dofus"

  - type: script
    dest-filename: start
    commands:
      - 'if [[ ! -f /var/data/Dofus/Dofus ]]; then'
      - '  user-install'
      - 'fi'
      - 'pwd=/var/data/Dofus /var/data/Dofus/Dofus "$@"'

- name: resources
  no-autogen: true
  buildsystem: simple
  build-commands:
  - install -d /app/share/applications
  - install -Dm555 com.ankama.Dofus.desktop /app/share/applications
  - install -d /app/share/icons/hicolor/256x256/apps/
  - install -Dm555 com.ankama.Dofus.png /app/share/icons/hicolor/256x256/apps/com.ankama.Dofus.png
  sources:
  - type: file
    path: com.ankama.Dofus.desktop
  - type: file
    path: com.ankama.Dofus.png
